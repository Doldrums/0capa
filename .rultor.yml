# a role of an architect in project, who will
# supervise all merge/release/deploy commands
architect:
  - xavzelada
  - Doldrums
# sensitive information, not intended to be accessible
# by all programmers stored into another private Github repository
# assets:
#   secret.xml: "reponam/secret-repo#assets/settings.xml"
docker:
  as_root: true
  image: ./docker-compose.yml
install:  |-
  git config --global user.email "server@0capa.com"
  git config --global user.name "0capa.com"
  sudo gem install bundler
  sudo bundle install --no-color "--gemfile=$(pwd)/Gemfile"
  dokku apps:create dokku@dokku.0capa.com:zerocapa
  dokku postgres:create zerocapadb
release:
  sensitive:
    - ./config/
  script: |-
    [[ "${tag}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || exit -1
    git remote add dokku dokku@dokku.0capa.com:zerocapa
    rm -rf ~/.ssh
    mkdir ~/.ssh
    mv ../id_rsa ../id_rsa.pub ~/.ssh
    chmod -R 600 ~/.ssh/*
    echo -e "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null" > ~/.ssh/config
    git fetch
    sed -i "s/BUILD/${tag}/g" ./version.rb
    git add ./version.rb
    git commit -m 'build number set'
    cp ../config.yml config.yml
    git add config.yml
    git commit -m 'config.yml'
    git push -f dokku $(git symbolic-ref --short HEAD):master
    git reset HEAD~1
    rm -rf config.yml
    curl -f --connect-timeout 15 -k --retry 5 --retry-delay 30 https://www.0pdd.com > /dev/null
merge:
  script: